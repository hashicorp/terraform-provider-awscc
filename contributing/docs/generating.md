# Generating The Terraform AWS Cloud Control Provider

This document describes the process of generating the Terraform AWS Cloud Control Provider.

The Terraform AWS Cloud Control Provider is generated from [CloudFormation resource type schemas](https://docs.aws.amazon.com/cloudformation-cli/latest/userguide/resource-types.html) via a number of distinct steps.

> [!IMPORTANT]  
> CloudFormation resource type schemas in the `us-east-1` AWS Region are used to generate the Terraform AWS Cloud Control Provider, so ensure that this is your default: `export AWS_DEFAULT_REGION=us-east-1`.

## List All Available CloudFormation Resource Type Schemas

An [HCL](https://github.com/hashicorp/hcl) configuration file containing information about all available CloudFormation resource type schemas is generated by running `go run internal/provider/generators/allschemas/main.go > path/to/list.hcl`.

This program calls the CloudFormation [`ListTypes` API](https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_ListTypes.html) (so valid AWS credentials must be set in the environment) for resources with `PUBLIC` visibility of the `IMMUTABLE` and `FULLY_MUTABLE` provisioning type. Non-AWS resources are filtered out.

The generated configuration file contains an entry of the form:

```hcl
resource_schema "aws_ec2_instance" {
  cloudformation_type_name = "AWS::EC2::Instance"
}
```

for each available CloudFormation resource type.

If the resource type does not support [existing resource discovery](https://docs.aws.amazon.com/cloudcontrolapi/latest/userguide/resource-operations-list.html), generation of the corresponding plural data source is suppressed:

```hcl
resource_schema "aws_ec2_ipam_allocation" {
  cloudformation_type_name               = "AWS::EC2::IPAMAllocation"
  suppress_plural_data_source_generation = true
}
```

## Download And Cache Schema Documents

So as to have reproducible builds, all available CloudFormation resource schemas are downloaded from the CloudFormation registry and are cached in this GitHub repository.

Running `make schemas`:

* Reads the file `internal/provider/all_schemas.hcl` (generated by the [type schema listing step above](#list-all-available-cloudformation-resource-type-schemas)).
* Downloads the latest CloudFormation resource type schema from the CloudFormation registry for each listed resource type, if there's not a cached schema file.
* Generates three Go source files, `resources.go`, `singular_data_sources.go` and `plural_data_sources.go`. These generated Go files contain code generation instructions to generate a resource schema, singular data source schema and plural data source schema (if not suppressed) for each resource type listed in the configuration file.

## Terraform Schema Generation

### Resources

Running `make resources`:

* Runs `go generate` on the `resources.go` file (generated by the [schema download step above](#download-and-cache-schema-documents)).
* This in turn runs the Terraform resource schema generator, which produces a Go file containing the Terraform schema and factory function for each configured resource (see [here](./resource-behavior.md#interpretation-of-cloudformation-resource-schemas) for details).

### Singular Data Sources

Running `make singular-data-sources`:

* Runs `go generate` on the `singular_data_sources.go` file (generated by the [schema download step above](#download-and-cache-schema-documents)).
* This in turn runs the Terraform singular data source schema generator, which produces a Go file containing the Terraform schema and factory function for each configured singular data source (see [here](./resource-behavior.md#interpretation-of-cloudformation-resource-schemas) for details).

### Plural Data Sources

Running `make plural-data-sources`:

* Runs `go generate` on the `plural_data_sources.go` file (generated by the [schema download step above](#download-and-cache-schema-documents)).
* This in turn runs the Terraform plural data source schema generator, which produces a Go file containing the Terraform schema and factory function for each configured plural data source (see [here](./resource-behavior.md#interpretation-of-cloudformation-resource-schemas) for details).

## Build Provider

Running `make build` compiles all the Go files [generated in the step above](#terraform-schema-generation) and links them with a generic implementation of a Terraform resource's CRUD methods. This code implements the interactions with the Cloud Control API [described here](./resource-behavior.md#interaction-with-the-cloud-control-api).
